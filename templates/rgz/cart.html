{% extends "base.html" %}

{% block lab %}Лабораторная работа 6 - Корзина{% endblock %}

{% block script %}
<script>
let cartItems = [];

// Проверка авторизации
async function checkAuth() {
    try {
        const response = await fetch('/lab6/api/user');
        const data = await response.json();
        
        if (!data.success) {
            window.location.href = "{{ url_for('lab5.login') }}";
            return;
        }
    } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = "{{ url_for('lab5.login') }}";
    }
}

// Загрузка корзины через JSON-RPC
async function loadCart() {
    try {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'get_cart',
            'id': Math.round(Math.random() * 1000)
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        });

        const data = await response.json();
        
        if (data.result) {
            cartItems = data.result;
            displayCart();
        } else if (data.error) {
            alert('Ошибка загрузки корзины: ' + data.error.message);
        }
    } catch (error) {
        console.error('Error loading cart:', error);
    }
}

// Отображение корзины
function displayCart() {
    const cartContent = document.getElementById('cart-content');
    const emptyCart = document.getElementById('empty-cart');
    
    if (cartItems.length === 0) {
        cartContent.style.display = 'none';
        emptyCart.style.display = 'block';
        return;
    }
    
    cartContent.style.display = 'block';
    emptyCart.style.display = 'none';
    
    let total = 0;
    let html = `
        <div class="cart-header">
            <h2>Ваша корзина</h2>
            <a href="{{ url_for('rgz.rgz') }}" class="back-link">← Продолжить покупки</a>
        </div>
        <div class="cart-items">
    `;
    
    cartItems.forEach(item => {
        const itemTotal = parseFloat(item.price) * item.quantity;
        total += itemTotal;
        
        html += `
            <div class="cart-item">
                <img src="${item.image_url || '/static/lab6/images/placeholder.jpg'}" alt="${item.name}">
                <div class="item-info">
                    <h3>${item.name}</h3>
                    <p class="item-price">${parseFloat(item.price).toFixed(2)} руб. × ${item.quantity}</p>
                </div>
                <div class="item-total">${itemTotal.toFixed(2)} руб.</div>
                <button class="remove-btn" onclick="removeFromCart(${item.id})">×</button>
            </div>
        `;
    });
    
    html += `</div>`;
    
    html += `
        <div class="cart-footer">
            <div class="total-amount">
                <strong>Общая сумма: ${total.toFixed(2)} руб.</strong>
            </div>
            <button class="checkout-btn" onclick="checkout()">Оформить заказ</button>
        </div>
    `;
    
    cartContent.innerHTML = html;
}

// Удаление из корзины через JSON-RPC
async function removeFromCart(itemId) {
    if (!confirm('Удалить товар из корзины?')) return;

    try {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'remove_from_cart',
            'params': { item_id: itemId },
            'id': Math.round(Math.random() * 1000)
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        });
        
        const data = await response.json();
        
        if (data.result) {
            loadCart();
        } else if (data.error) {
            switch(data.error.code) {
                case 1:
                    alert('Вы не авторизованы, пожалуйста, авторизуйтесь!');
                    break;
                case 3:
                    alert('Товар не найден в корзине');
                    break;
                default:
                    alert('Ошибка: ' + data.error.message);
            }
        }
    } catch (error) {
        console.error('Error removing from cart:', error);
    }
}

// Оформление заказа через JSON-RPC
async function checkout() {
    const address = prompt('Введите адрес доставки:');
    if (!address) {
        alert('Адрес доставки обязателен для оформления заказа');
        return;
    }
    
    if (!address.trim()) {
        alert('Адрес доставки не может быть пустым');
        return;
    }
    
    try {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'create_order',
            'params': { shipping_address: address },
            'id': Math.round(Math.random() * 1000)
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        });
        
        const data = await response.json();
        
        if (data.result) {
            alert(`Заказ №${data.result.order_id} успешно оформлен! Сумма: ${data.result.total_amount} руб.`);
            window.location.href = "{{ url_for('rgz.rgz') }}";
        } else if (data.error) {
            switch(data.error.code) {
                case 1:
                    alert('Вы не авторизованы, пожалуйста, авторизуйтесь!');
                    break;
                case 2:
                    alert('Корзина пуста');
                    break;
                default:
                    alert('Ошибка оформления заказа: ' + data.error.message);
            }
        }
    } catch (error) {
        console.error('Error creating order:', error);
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadCart();
});
</script>
{% endblock %}

{% block main %}
<div class="cart-container">
    <div id="cart-content" style="display: none;">
        <!-- Содержимое корзины загружается через JavaScript -->
    </div>
    
    <div id="empty-cart" style="display: none; text-align: center; padding: 40px;">
        <h2>Корзина пуста</h2>
        <p>Добавьте товары из каталога</p>
        <a href="{{ url_for('rgz.rgz') }}" class="back-link">Перейти к покупкам</a>
    </div>
</div>

<style>
.cart-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
}

.cart-header h2 {
    color: #2c3e50;
    margin: 0;
}

.back-link {
    color: #3498db;
    text-decoration: none;
    padding: 8px 16px;
    border: 1px solid #3498db;
    border-radius: 5px;
    transition: all 0.3s ease;
}

.back-link:hover {
    background: #3498db;
    color: white;
    text-decoration: none;
}

.cart-items {
    margin-bottom: 30px;
}

.cart-item {
    display: flex;
    align-items: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    position: relative;
}

.cart-item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 20px;
}

.item-info {
    flex: 1;
}

.item-info h3 {
    margin: 0 0 5px 0;
    color: #2c3e50;
    font-size: 1.1rem;
}

.item-price {
    color: #7f8c8d;
    margin: 0;
    font-size: 0.9rem;
}

.item-total {
    font-weight: bold;
    color: #e74c3c;
    font-size: 1.1rem;
    margin-right: 40px;
}

.remove-btn {
    position: absolute;
    right: 15px;
    top: 15px;
    background: #e74c3c;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
}

.remove-btn:hover {
    background: #c0392b;
}

.cart-footer {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #e9ecef;
}

.total-amount {
    font-size: 1.3rem;
    color: #2c3e50;
    margin-bottom: 20px;
}

.checkout-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1.1rem;
    transition: background 0.3s ease;
}

.checkout-btn:hover {
    background: #219a52;
}

@media (max-width: 768px) {
    .cart-container {
        padding: 10px;
    }
    
    .cart-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .cart-item {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .cart-item img {
        margin-right: 0;
    }
    
    .item-total {
        margin-right: 0;
    }
    
    .remove-btn {
        position: static;
        align-self: flex-end;
    }
}
</style>
{% endblock %}