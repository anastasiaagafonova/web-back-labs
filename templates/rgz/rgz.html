{% extends "base.html" %}

{% block lab %}Лабораторная работа 6 - Мебельный магазин{% endblock %}

{% block script %}
<script>
let currentUser = null;
let products = [];

// Проверка авторизации
async function checkAuth() {
    try {
        const response = await fetch('/rgz/api/user');
        const data = await response.json();
        
        if (data.success) {
            currentUser = data.user;
            updateAuthInfo();
            updateCartCount();
        }
    } catch (error) {
        console.error('Auth check error:', error);
    }
}

// Обновление информации об авторизации
function updateAuthInfo() {
    const authInfo = document.getElementById('auth-info');
    const userMenu = document.getElementById('user-menu');
    
    if (currentUser) {
        authInfo.innerHTML = `
            <p>Вы вошли как: <strong>${currentUser.login}</strong></p>
            <a href="{{ url_for('lab5.logout') }}">Выйти</a>
        `;
        userMenu.style.display = 'block';
    } else {
        authInfo.innerHTML = `
            <p>Для покупок необходимо <a href="{{ url_for('lab5.login') }}">войти</a> или 
            <a href="{{ url_for('lab5.register') }}">зарегистрироваться</a></p>
        `;
        userMenu.style.display = 'none';
    }
}

// Загрузка товаров через JSON-RPC
async function loadProducts() {
    try {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'get_products',
            'id': Math.round(Math.random() * 1000)
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        });
        
        const data = await response.json();
        
        if (data.result) {
            products = data.result;
            displayProducts(products);
        } else if (data.error) {
            console.error('Error loading products:', data.error);
        }
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Отображение товаров
function displayProducts(productsToShow) {
    const grid = document.getElementById('products-grid');
    grid.innerHTML = '';

    if (productsToShow.length === 0) {
        grid.innerHTML = '<p class="no-products">Товары не найдены</p>';
        return;
    }

    productsToShow.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.innerHTML = `
            <img src="${product.image_url || '/static/lab6/images/placeholder.jpg'}" alt="${product.name}" onerror="this.src='/static/lab6/images/placeholder.jpg'">
            <h3>${product.name}</h3>
            <p class="product-description">${product.description || 'Описание отсутствует'}</p>
            <div class="product-price">${parseFloat(product.price).toFixed(2)} руб.</div>
            <div class="product-details">
                <small>Категория: ${product.category || 'Не указана'}</small>
                <small>Материал: ${product.material || 'Не указан'}</small>
                <small>В наличии: ${product.stock} шт.</small>
            </div>
            ${currentUser ? `
                <button class="add-to-cart-btn" onclick="addToCart(${product.id})" ${product.stock <= 0 ? 'disabled' : ''}>
                    ${product.stock <= 0 ? 'Нет в наличии' : 'В корзину'}
                </button>
            ` : ''}
        `;
        grid.appendChild(productCard);
    });
}

// Добавление в корзину через JSON-RPC
async function addToCart(productId) {
    if (!currentUser) {
        alert('Для добавления в корзину необходимо авторизоваться');
        return;
    }

    try {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'add_to_cart',
            'params': { product_id: productId, quantity: 1 },
            'id': Math.round(Math.random() * 1000)
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        });

        const data = await response.json();
        
        if (data.result) {
            alert('Товар добавлен в корзину!');
            updateCartCount();
        } else if (data.error) {
            switch(data.error.code) {
                case 1:
                    alert('Вы не авторизованы, пожалуйста, авторизуйтесь!');
                    break;
                default:
                    alert('Ошибка: ' + data.error.message);
            }
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
    }
}

// Обновление счетчика корзины
async function updateCartCount() {
    if (!currentUser) return;

    try {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'get_cart',
            'id': Math.round(Math.random() * 1000)
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        });
        
        const data = await response.json();
        
        if (data.result) {
            const totalItems = data.result.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }
    } catch (error) {
        console.error('Error updating cart count:', error);
    }
}

// Просмотр корзины
function viewCart() {
    window.location.href = "{{ url_for('rgz.cart') }}";
}

// Фильтрация товаров
function setupFilters() {
    const categoryFilter = document.getElementById('category-filter');
    const searchInput = document.getElementById('search');

    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterProducts);
    }
    if (searchInput) {
        searchInput.addEventListener('input', filterProducts);
    }
}

function filterProducts() {
    const category = document.getElementById('category-filter')?.value || '';
    const search = document.getElementById('search')?.value.toLowerCase() || '';

    let filtered = products;

    if (category) {
        filtered = filtered.filter(product => product.category === category);
    }

    if (search) {
        filtered = filtered.filter(product => 
            product.name.toLowerCase().includes(search) ||
            (product.description && product.description.toLowerCase().includes(search)) ||
            (product.material && product.material.toLowerCase().includes(search))
        );
    }

    displayProducts(filtered);
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadProducts();
    setupFilters();
});
</script>
{% endblock %}

{% block main %}
<div class="furniture-store-container">
    <h1 class="store-title">Каталог мебели</h1>
    
    <!-- Блок авторизации -->
    <div class="auth-info" id="auth-info">
        <p>Загрузка...</p>
    </div>

    <!-- Меню пользователя -->
    <div class="user-menu" id="user-menu" style="display: none;">
        <button onclick="viewCart()">Корзина (<span id="cart-count">0</span>)</button>
    </div>

    <!-- Фильтры -->
    <div class="filters">
        <select id="category-filter">
            <option value="">Все категории</option>
            <option value="Диваны">Диваны</option>
            <option value="Кресла">Кресла</option>
            <option value="Столы">Столы</option>
            <option value="Стулья">Стулья</option>
            <option value="Кровати">Кровати</option>
            <option value="Шкафы">Шкафы</option>
            <option value="Комоды">Комоды</option>
            <option value="Тумбы">Тумбы</option>
        </select>
        <input type="text" id="search" placeholder="Поиск по названию, описанию, материалу...">
    </div>

    <!-- Сетка товаров -->
    <div class="products-grid" id="products-grid">
        <!-- Товары загружаются через JavaScript -->
    </div>
</div>

<style>
.furniture-store-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.store-title {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 30px;
    font-size: 2.5rem;
}

.auth-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
    border-left: 4px solid #3498db;
}

.auth-info p {
    margin: 0;
    color: #333;
}

.auth-info a {
    color: #3498db;
    text-decoration: none;
    margin: 0 10px;
    padding: 5px 10px;
    border: 1px solid #3498db;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.auth-info a:hover {
    background: #3498db;
    color: white;
}

.user-menu {
    text-align: center;
    margin-bottom: 20px;
}

.user-menu button {
    background: #27ae60;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s ease;
}

.user-menu button:hover {
    background: #219a52;
}

.filters {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.filters select, .filters input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    min-width: 200px;
}

.filters input {
    flex: 1;
    min-width: 300px;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.product-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e9ecef;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.product-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 5px;
    margin-bottom: 15px;
}

.product-card h3 {
    color: #2c3e50;
    margin: 0 0 10px 0;
    font-size: 1.2rem;
    min-height: 2.8em;
}


.product-price {
    font-size: 1.3rem;
    font-weight: bold;
    color: #e74c3c;
    margin: 10px 0;
}

.product-details {
    margin: 10px 0;
}

.product-details small {
    display: block;
    color: #7f8c8d;
    margin: 2px 0;
}

.add-to-cart-btn {
    width: 100%;
    background: #3498db;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s ease;
    margin-top: 10px;
}

.add-to-cart-btn:hover:not(:disabled) {
    background: #2980b9;
}

.add-to-cart-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}

.no-products {
    text-align: center;
    color: #7f8c8d;
    font-size: 1.2rem;
    grid-column: 1 / -1;
    padding: 40px;
}

@media (max-width: 768px) {
    .furniture-store-container {
        padding: 10px;
    }
    
    .filters {
        flex-direction: column;
    }
    
    .filters select, .filters input {
        min-width: auto;
        width: 100%;
    }
    
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }
}
</style>
{% endblock %}