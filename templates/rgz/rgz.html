{% extends "base.html" %}

{% block lab %}Магазин мебели "Отдыхайка"{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='rgz/rgz.css') }}">
{% endblock %}

{% block script %}
<script>
    let currentFurniture = [];
    // функция для вызова API методов
    async function callApi(method, params = {}) {
        const response = await fetch('/rgz/api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: method,
                params: params,
                id: Math.floor(Math.random() * 1000)
            })
        });
        
        return await response.json();
    }
    // Добавьте в script блок rgz.html:
async function loadFurniture() {
    try {
        const result = await callApi('get_products');
        if (result.result) {
            renderFurniture(result.result);
        } else if (result.error) {
            console.error('Error:', result.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderFurniture(products) {
    const grid = document.getElementById('furniture-grid');
    let html = '';
    
    products.forEach(product => {
        html += `
            <div class="furniture-item">
                <img src="${product.image_url || '/static/default.jpg'}" alt="${product.name}">
                <h3>${product.name}</h3>
                <p class="price">${parseFloat(product.price).toLocaleString('ru-RU')} руб.</p>
                ${login ? `
                    <button onclick="addToCart(${product.id})" class="add-to-cart-btn">
                        В корзину
                    </button>
                ` : ''}
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

async function addToCart(productId) {
    try {
        const result = await callApi('add_to_cart', { product_id: productId });
        if (result.result) {
            alert('Товар добавлен в корзину!');
        } else if (result.error) {
            alert('Ошибка: ' + result.error.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function deleteAccount() {
    if (confirm('Вы уверены, что хотите удалить аккаунт? Это действие необратимо.')) {
        try {
            const result = await callApi('delete_account');
            if (result.result) {
                alert('Аккаунт удален');
                window.location.href = '/rgz/';
            } else if (result.error) {
                alert('Ошибка: ' + result.error.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
}

    document.addEventListener('DOMContentLoaded', function() {
        loadFurniture();
    });

</script>
{% endblock %}


{% block main %}
    <div class="rgz-container">
        <div class="rgz-header">
            <h1>Магазин мебели</h1>
        </div>

        <div class="user-panel">
            {% if login %}
                <div class="user-info">
                    Пользователь: {{ login }}
                </div>
                <div class="user-actions">
                    <a href="/rgz/cart" class="cart-btn">Корзина</a>
                    <a href="/rgz/logout" class="logout-btn">Выйти</a>
                    <button onclick="deleteAccount()" class="delete-account-btn">Удалить аккаунт</button>
                </div>
            {% else %}
                <div class="user-info">
                    Для покупок необходимо авторизоваться
                </div>
                <div class="user-actions">
                    <a href="/rgz/login" class="login-btn">Войти</a>
                    <a href="/rgz/register" class="register-btn">Регистрация</a>
                </div>
            {% endif %}
        </div>

        <div class="furniture-grid" id="furniture-grid">
            <div class="loading">Загрузка товаров...</div>
        </div>
    </div>
{% endblock %}